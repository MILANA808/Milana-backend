name: Publish endpoint to GitHub Pages

on:
  workflow_run:
    workflows: ['Run AKSI backend via Cloudflare Tunnel']
    types: [completed]

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download endpoint artifact
        uses: actions/download-artifact@v4
        with:
          name: endpoint
          path: ./public

      - name: Prepare Pages content
        run: |
          mkdir -p public
          cat > public/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>AKSI Backend Redirect</title>
          <style>body{font-family:system-ui,Arial;margin:2rem}</style>
          <h1>AKSI Backend</h1>
          <p>Перенаправляю на активный бэкенд…</p>
          <script>
          fetch('endpoint.json',{cache:'no-store'})
            .then(r=>r.json())
            .then(j=>{ if(j.url) location.replace(j.url + '/docs'); })
            .catch(()=>document.body.innerHTML='<h2>Нет активного адреса</h2><p>Подождите минуту и обновите страницу.</p>');
          </script>
          HTML

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to Pages
        uses: actions/deploy-pages@v4
